<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .analytics-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .analytics-card:hover {
            transform: translateY(-2px);
        }
        .priority-bar {
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(90deg, #ff6b6b 0%, #feca57 50%, #48ca6b 100%);
        }
        .query-item {
            transition: all 0.3s;
            cursor: pointer;
        }
        .query-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-stable { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 sidebar p-3">
                <div class="text-center mb-4">
                    <h3 class="mb-0"><i class="fas fa-balance-scale"></i> JuSimples</h3>
                    <small class="text-muted">Admin Dashboard v3.0</small>
                </div>
                
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{{ url_for('admin_v3.dashboard') }}">
                            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{{ url_for('admin_v3.knowledge_base') }}">
                            <i class="fas fa-book me-2"></i> Knowledge Base
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{{ url_for('admin_v3.openai_management') }}">
                            <i class="fas fa-brain me-2"></i> OpenAI API
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{{ url_for('admin_v3.lexml_management') }}">
                            <i class="fas fa-gavel me-2"></i> LexML API
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{{ url_for('admin_v3.rag_system') }}">
                            <i class="fas fa-search me-2"></i> RAG System
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link active" href="{{ url_for('admin_v3.query_analytics') }}">
                            <i class="fas fa-chart-line me-2"></i> Query Analytics
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- Main Content -->
            <main class="col-md-10 main-content p-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Query Analytics & Prioritization</h1>
                    <div>
                        <select class="form-select me-2 d-inline-block" style="width: auto;" onchange="changePeriod(this.value)">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                        <button class="btn btn-outline-secondary" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="analytics-card p-3 text-center">
                            <div class="text-primary">
                                <i class="fas fa-question-circle fa-2x mb-2"></i>
                            </div>
                            <h4 class="mb-1">{{ query_stats.get('total_queries', 0) }}</h4>
                            <small class="text-muted">Total Queries</small>
                            <div class="mt-2">
                                <small class="badge bg-info">{{ query_stats.get('unique_sessions', 0) }} sessions</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="analytics-card p-3 text-center">
                            <div class="text-success">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                            </div>
                            <h4 class="mb-1">{{ "{:.1f}".format(query_stats.get('success_rate', 0)) }}%</h4>
                            <small class="text-muted">Success Rate</small>
                            <div class="mt-2">
                                <small class="text-muted">{{ query_stats.get('successful_queries', 0) }} successful</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="analytics-card p-3 text-center">
                            <div class="text-info">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                            </div>
                            <h4 class="mb-1">{{ "{:.0f}".format(query_stats.get('avg_response_time', 0)) }}ms</h4>
                            <small class="text-muted">Avg Response Time</small>
                            <div class="mt-2">
                                <small class="badge bg-{{ 'success' if query_stats.get('avg_response_time', 0) < 2000 else 'warning' if query_stats.get('avg_response_time', 0) < 5000 else 'danger' }}">
                                    {{ 'Fast' if query_stats.get('avg_response_time', 0) < 2000 else 'Medium' if query_stats.get('avg_response_time', 0) < 5000 else 'Slow' }}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="analytics-card p-3 text-center">
                            <div class="text-warning">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                            </div>
                            <h4 class="mb-1">${{ "{:.2f}".format(query_stats.get('total_cost', 0)) }}</h4>
                            <small class="text-muted">Total Cost</small>
                            <div class="mt-2">
                                <small class="text-muted">${{ "{:.4f}".format(query_stats.get('total_cost', 0) / (query_stats.get('total_queries') or 1)) }}/query</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Query Trends Chart -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="analytics-card p-4">
                            <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Query Trends</h5>
                            <canvas id="queryTrendsChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Top Queries (Prioritization) -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="analytics-card p-4">
                            <h5 class="mb-3">
                                <i class="fas fa-fire me-2"></i>Top Queries (Priority Ranking)
                                <span class="badge bg-primary ms-2">{{ top_queries|length }}</span>
                            </h5>
                            {% if top_queries %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Question</th>
                                            <th>Frequency</th>
                                            <th>Success Rate</th>
                                            <th>Priority Score</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for query in top_queries[:15] %}
                                        <tr class="query-item" onclick="analyzeQuery('{{ loop.index }}')">
                                            <td>
                                                <span class="badge bg-{{ 'danger' if loop.index <= 3 else 'warning' if loop.index <= 10 else 'secondary' }}">
                                                    {{ loop.index }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 400px;" title="{{ query.question }}">
                                                    {{ query.question }}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ query.frequency }}x</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress me-2" style="width: 60px; height: 8px;">
                                                        <div class="progress-bar bg-success" 
                                                             style="width: 85%"></div>
                                                    </div>
                                                    <small>{{ "{:.0f}".format(query.success_rate) }}%</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="priority-bar me-2" style="width: 40px; height: 8px;">
                                                        <div class="priority-bar-fill" style="width: 70%; height: 100%; background: #28a745; border-radius: 10px;"></div>
                                                    </div>
                                                    <small>{{ "{:.1f}".format(query.priority_score) }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); optimizeQuery('{{ loop.index }}')">
                                                    <i class="fas fa-cog"></i> Optimize
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No query data available yet</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="analytics-card p-4 mb-3">
                            <h6 class="mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Failed Queries</h6>
                            {% if failed_queries %}
                            {% for query in failed_queries[:5] %}
                            <div class="border-start border-danger ps-3 mb-3">
                                <div class="text-truncate mb-1" title="{{ query.question }}">
                                    <strong>{{ query.question }}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-danger">{{ query.failure_count }} failures</small>
                                    <small class="text-muted">{{ query.last_failed }}</small>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted text-center">No recent failures</p>
                            {% endif %}
                        </div>
                        
                        <div class="analytics-card p-4">
                            <h6 class="mb-3"><i class="fas fa-lightbulb me-2"></i>Optimization Tips</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small>Focus on top 10 queries for maximum impact</small>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small>Improve knowledge base for frequent queries</small>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small>Add specific content for failed queries</small>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small>Monitor response time trends</small>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize query trends chart
        function initQueryTrendsChart() {
            const ctx = document.getElementById('queryTrendsChart');
            if (!ctx) return;
            
            const trendsData = [{"date": "2024-01", "query_count": 100, "successful_count": 85}];
            
            const labels = trendsData.map(item => item.date);
            const queryCount = trendsData.map(item => item.query_count);
            const successfulCount = trendsData.map(item => item.successful_count);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Queries',
                        data: queryCount,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Successful Queries',
                        data: successfulCount,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        function changePeriod(days) {
            // TODO: Implement period change functionality
            console.log('Changing period to:', days, 'days');
        }
        
        function analyzeQuery(index) {
            alert('Query analysis feature coming soon!');
        }
        
        function optimizeQuery(index) {
            alert('Query optimization feature coming soon!');
        }
        
        function exportAnalytics() {
            alert('Export analytics feature coming soon!');
        }
        
        // Initialize chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initQueryTrendsChart();
        });
    </script>
</body>
</html>
