<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI Dashboard - Admin JuSimples</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .section { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #333; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2em; font-weight: bold; color: #333; }
        .stat-label { color: #666; margin-top: 5px; }
        .config-grid { display: grid; grid-template-columns: 200px 1fr; gap: 15px; margin-bottom: 20px; }
        .config-label { font-weight: 600; color: #666; }
        .config-value { color: #333; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #cce5ff; color: #004085; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f8f9fa; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        .back-link { color: #667eea; text-decoration: none; margin-bottom: 20px; display: inline-block; }
        .back-link:hover { text-decoration: underline; }
        .cost-display { font-size: 1.2em; font-weight: bold; color: #28a745; }
        .api-key-preview { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 5px 10px; border-radius: 5px; }
        .model-badge { background: #e3f2fd; color: #1565c0; padding: 5px 10px; border-radius: 5px; font-weight: 600; }
        
        /* Button styles */
        .btn { display: inline-block; font-weight: 400; text-align: center; white-space: nowrap; vertical-align: middle; user-select: none; border: 1px solid transparent; padding: 0.375rem 0.75rem; font-size: 1rem; line-height: 1.5; border-radius: 0.25rem; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; line-height: 1.5; border-radius: 0.2rem; }
        .btn-primary { color: #fff; background-color: #667eea; border-color: #5a73e8; }
        .btn-primary:hover { background-color: #4c63de; border-color: #3f57d4; }
        .btn-success { color: #fff; background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; border-radius: 5px; width: 50%; max-width: 500px; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-footer { border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: black; }
        
        /* Form styles */
        .form-group { margin-bottom: 15px; }
        .form-control { display: block; width: 100%; padding: 0.375rem 0.75rem; font-size: 1rem; line-height: 1.5; color: #495057; background-color: #fff; background-clip: padding-box; border: 1px solid #ced4da; border-radius: 0.25rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .form-label { margin-bottom: 0.5rem; display: inline-block; }
        
        /* Alert styles */
        .alert { position: relative; padding: 0.75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.25rem; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ü§ñ OpenAI Dashboard</h1>
            <p>Monitoramento e controle da API OpenAI</p>
        </div>
    </div>

    <div class="container">
        <a href="/admin" class="back-link">‚Üê Voltar ao Dashboard</a>

        {% if error %}
        <div class="section" style="background: #f8d7da; color: #721c24;">
            <strong>Erro:</strong> {{ error }}
        </div>
        {% endif %}

        <!-- API Configuration -->
        <div class="section">
            <h2>‚öôÔ∏è Configura√ß√£o da API</h2>
            <div class="config-grid">
                <div class="config-label">Status da API:</div>
                <div class="config-value">
                    {% if config.api_key_configured %}
                    <span class="badge badge-success">‚úì Configurada</span>
                    {% else %}
                    <span class="badge badge-warning">‚úó N√£o Configurada</span>
                    {% endif %}
                </div>
                
                <div class="config-label">API Key:</div>
                <div class="config-value">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        {% if config.api_key_preview %}
                        <span class="api-key-preview">{{ config.api_key_preview }}</span>
                        {% else %}
                        <span style="color: #999;">N√£o configurada</span>
                        {% endif %}
                        <button id="editApiKeyBtn" class="btn btn-sm btn-primary">Editar</button>
                    </div>
                </div>
                
                <div class="config-label">Modelo Padr√£o:</div>
                <div class="config-value">
                    <span class="model-badge">{{ config.default_model }}</span>
                </div>
                
                <div class="config-label">Temperature:</div>
                <div class="config-value">{{ config.temperature }}</div>
                
                <div class="config-label">Max Tokens:</div>
                <div class="config-value">{{ config.max_tokens }}</div>
                
                <div class="config-label">Modelo de Embedding:</div>
                <div class="config-value">
                    <span class="model-badge">{{ config.embedding_model }}</span>
                </div>
            </div>
        </div>

        <!-- Usage Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_requests|default(0) }}</div>
                <div class="stat-label">Total de Requisi√ß√µes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "{:,}".format(stats.total_tokens|default(0)) }}</div>
                <div class="stat-label">Tokens Totais</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "{:,}".format(stats.total_input_tokens|default(0)) }}</div>
                <div class="stat-label">Tokens de Entrada</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "{:,}".format(stats.total_output_tokens|default(0)) }}</div>
                <div class="stat-label">Tokens de Sa√≠da</div>
            </div>
            <div class="stat-card">
                <div class="stat-value cost-display">R$ {{ "%.4f"|format(stats.total_cost|default(0)) }}</div>
                <div class="stat-label">Custo Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "%.1f"|format(stats.avg_response_time|default(0)) }}ms</div>
                <div class="stat-label">Tempo M√©dio</div>
            </div>
        </div>

        <!-- Model Usage Distribution -->
        {% if stats.models %}
        <div class="section">
            <h2>üìä Uso por Modelo</h2>
            <table>
                <thead>
                    <tr>
                        <th>Modelo</th>
                        <th>Requisi√ß√µes</th>
                        <th>Tokens</th>
                        <th>Custo</th>
                        <th>% do Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model in stats.models %}
                    <tr>
                        <td><span class="model-badge">{{ model.model }}</span></td>
                        <td>{{ model.count }}</td>
                        <td>{{ "{:,}".format(model.tokens) }}</td>
                        <td>R$ {{ "%.4f"|format(model.cost) }}</td>
                        <td>
                            <div class="progress-bar" style="width: 100px; display: inline-block;">
                                <div class="progress-fill model-progress" data-percent="{{ (model.count / stats.total_requests * 100) if stats.total_requests > 0 else 0 }}"></div>
                            </div>
                            {{ "%.1f"|format((model.count / stats.total_requests * 100) if stats.total_requests > 0 else 0) }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Daily Usage -->
        {% if stats.daily_usage %}
        <div class="section">
            <h2>üìà Uso Di√°rio (√∫ltimos 30 dias)</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Requisi√ß√µes</th>
                            <th>Tokens</th>
                            <th>Custo</th>
                            <th>Visualiza√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in stats.daily_usage[:10] %}
                        <tr>
                            <td>{{ day.date }}</td>
                            <td>{{ day.requests }}</td>
                            <td>{{ "{:,}".format(day.tokens) }}</td>
                            <td>R$ {{ "%.4f"|format(day.cost) }}</td>
                            <td>
                                <div class="progress-bar" style="width: 150px;">
                                    <div class="progress-fill day-progress" data-percent="{{ (day.requests / stats.daily_usage[0].requests * 100) if stats.daily_usage[0].requests > 0 else 0 }}"></div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Error Rate -->
        <div class="section">
            <h2>‚ö†Ô∏è Taxa de Erro</h2>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="flex: 1;">
                    <div class="progress-bar" style="height: 30px;">
                        <div class="progress-fill error-progress" data-percent="{{ 100 - stats.error_rate }}" data-color="#28a745"></div>
                    </div>
                </div>
                <div>
                    <span style="font-size: 1.5em; font-weight: bold;">{{ "%.1f"|format(stats.error_rate) }}%</span> de erro
                </div>
            </div>
        </div>

        <!-- Cost Breakdown -->
        <div class="section">
            <h2>üí∞ An√°lise de Custos</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Custo M√©dio por Requisi√ß√£o</div>
                    <div class="stat-value">R$ {{ "%.6f"|format((stats.total_cost / stats.total_requests) if stats.total_requests > 0 else 0) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Custo por 1K Tokens</div>
                    <div class="stat-value">R$ {{ "%.4f"|format((stats.total_cost / stats.total_tokens * 1000) if stats.total_tokens > 0 else 0) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tokens por Requisi√ß√£o</div>
                    <div class="stat-value">{{ (stats.total_tokens // stats.total_requests) if stats.total_requests > 0 else 0 }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Atualizar Chave da API</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div id="alertContainer"></div>
            <form id="apiKeyForm">
                <div class="form-group">
                    <label for="apiKey" class="form-label">Nova Chave da API OpenAI</label>
                    <input type="text" id="apiKey" name="apiKey" class="form-control" placeholder="sk-..." required>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Sua chave da API ser√° armazenada no arquivo .env do servidor e nunca ser√° compartilhada.
                    </small>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancelApiKey" class="btn">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Apply progress bar widths after page load to avoid CSS validation errors
        document.addEventListener('DOMContentLoaded', function() {
            // Apply model progress bars
            document.querySelectorAll('.model-progress').forEach(function(el) {
                el.style.width = el.getAttribute('data-percent') + '%';
            });
            
            // Apply daily usage progress bars
            document.querySelectorAll('.day-progress').forEach(function(el) {
                el.style.width = el.getAttribute('data-percent') + '%';
            });
            
            // Apply error progress bar
            document.querySelectorAll('.error-progress').forEach(function(el) {
                el.style.width = el.getAttribute('data-percent') + '%';
                if (el.hasAttribute('data-color')) {
                    el.style.background = el.getAttribute('data-color');
                }
            });

            // API Key Modal functionality
            const modal = document.getElementById('apiKeyModal');
            const editBtn = document.getElementById('editApiKeyBtn');
            const closeBtn = document.querySelector('.close-modal');
            const cancelBtn = document.getElementById('cancelApiKey');
            const apiKeyForm = document.getElementById('apiKeyForm');
            const alertContainer = document.getElementById('alertContainer');
            
            // Open modal
            editBtn.addEventListener('click', function() {
                modal.style.display = 'block';
            });
            
            // Close modal
            function closeModal() {
                modal.style.display = 'none';
                alertContainer.innerHTML = '';
                apiKeyForm.reset();
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Click outside modal to close
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Submit form
            apiKeyForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                // Basic validation
                if (!apiKey.startsWith('sk-')) {
                    showAlert('error', 'Chave de API OpenAI inv√°lida. Deve come√ßar com "sk-"');
                    return;
                }
                
                // Send API request
                fetch('/admin/api/openai/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ api_key: apiKey })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', 'Chave da API atualizada com sucesso!');
                        setTimeout(() => {
                            location.reload();
                        }, 2000); // Reload after 2 seconds
                    } else {
                        showAlert('error', data.error || 'Erro ao atualizar chave da API');
                    }
                })
                .catch(error => {
                    showAlert('error', 'Erro ao comunicar com o servidor: ' + error);
                });
            });
            
            // Helper to show alerts
            function showAlert(type, message) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            }
        });
        
        // Auto refresh page every 60 seconds
        setTimeout(function() {
            location.reload();
        }, 60000);
    </script>
</body>
</html>
